<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather Dashboard - WeatherWise</title>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    <!-- Leaflet CSS for map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <!-- Chart.js for charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            transition: background 0.3s ease;
        }
        .dashboard-page {
            width: 100%;
            max-width: 1200px;
        }

        /* Header */
        .dashboard-header {
            text-align: center;
            margin-bottom: 30px;
        }
        .search-box {
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50px;
            padding: 10px 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: box-shadow 0.3s ease;
        }
        .search-box:hover {
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }
        .search-icon {
            color: #667eea;
            margin-right: 10px;
        }
        #cityInput {
            border: none;
            outline: none;
            padding: 10px;
            font-size: 16px;
            flex: 1;
            background: transparent;
        }
        .btn {
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            margin-left: 10px;
        }
        .btn-secondary {
            background: #667eea;
            color: white;
        }
        .btn-secondary:hover {
            background: #5a6fd8;
        }
        .btn-primary {
            background: #28a745;
            color: white;
        }
        .btn-primary:hover {
            background: #218838;
        }

        /* Loader */
        .loader {
            display: none;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Error Message */
        .error-message {
            display: none;
            background: #ff6b6b;
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        /* Weather Results */
        #weather-results {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .location-title {
            text-align: center;
            font-size: 2.5em;
            margin-bottom: 20px;
            color: #333;
        }

        /* Main Grid */
        .main-weather-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        /* Left Column */
        .left-column {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .now-card {
            text-align: center;
        }
        .now-label {
            font-size: 1.2em;
            color: #667eea;
        }
        .now-main {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 10px 0;
        }
        .now-temp {
            font-size: 4em;
            font-weight: bold;
            color: #333;
        }
        .now-icon {
            width: 80px;
            height: 80px;
            margin-left: 20px;
        }
        .now-desc {
            font-size: 1.2em;
            color: #666;
        }
        .card-divider {
            margin: 15px 0;
            border: none;
            border-top: 1px solid #eee;
        }
        .now-detail {
            color: #888;
        }

        /* Forecast */
        .forecast-5day-card h4 {
            margin-bottom: 15px;
            color: #333;
        }
        .daily-forecast-list {
            list-style: none;
            padding: 0;
        }
        .forecast-list-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .forecast-list-item:last-child {
            border-bottom: none;
        }
        .forecast-list-item img {
            width: 40px;
            height: 40px;
        }

        /* Right Column */
        .right-column h4 {
            margin-bottom: 20px;
            color: #333;
        }
        .highlights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .highlight-card h5 {
            margin-bottom: 10px;
            color: #667eea;
        }
        .highlight-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .highlight-icon {
            font-size: 2em;
            color: #667eea;
        }
        .highlight-value {
            font-size: 1.5em;
            font-weight: bold;
        }

        /* AQI Specific */
        .aqi-main {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .aqi-icon {
            font-size: 2em;
            margin-right: 15px;
            color: #667eea;
        }
        .aqi-info {
            display: flex;
            flex-direction: column;
        }
        .aqi-value {
            font-size: 2em;
            font-weight: bold;
        }
        .aqi-desc {
            color: #666;
        }
        .air-components {
            display: flex;
            justify-content: space-around;
            font-size: 0.9em;
            color: #888;
        }

        /* Sunrise/Sunset */
        .sun-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .sun-icon {
            font-size: 1.5em;
            margin-right: 15px;
            color: #ffa500;
        }
        .sun-info {
            display: flex;
            flex-direction: column;
        }
        .sun-time {
            font-size: 1.2em;
            font-weight: bold;
        }

        /* Chart */
        .chart-card {
            margin-bottom: 30px;
        }
        #hourlyTempChart {
            max-height: 300px;
        }

        /* Map */
        .map-card {
            margin-bottom: 30px;
        }
        .map-controls {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }
        .map-controls label {
            margin-right: 10px;
            font-weight: bold;
        }
        .map-controls select {
            padding: 5px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        #map {
            height: 300px;
            border-radius: 10px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-weather-grid {
                grid-template-columns: 1fr;
            }
            .highlights-grid {
                grid-template-columns: 1fr;
            }
            .location-title {
                font-size: 2em;
            }
            .now-temp {
                font-size: 3em;
            }
        }
    </style>
</head>
<body class="dashboard-page">
    <div class="dashboard-header">
        <div class="search-box">
            <i class="fas fa-map-marker-alt search-icon"></i>
            <input type="text" id="cityInput" placeholder="Enter City Name...">
            <button id="searchBtn" class="btn btn-secondary"><i class="fas fa-search"></i> Search</button>
            <button id="currentLocBtn" class="btn btn-primary"><i class="fas fa-crosshairs"></i> Current Location</button>
        </div>
    </div>

    <div id="loader" class="loader"></div>
    <div id="errorMessage" class="error-message"></div>

    <div id="weather-results">
        <h3 id="locationName" class="location-title">--</h3>

        <div class="main-weather-grid">
            <div class="left-column">
                <div class="card now-card">
                    <p class="now-label">Now</p>
                    <div class="now-main">
                        <span id="currentTemp" class="now-temp">--°C</span>
                        <img id="currentIcon" src="https://openweathermap.org/img/wn/01d@2x.png" alt="--" class="now-icon">
                    </div>
                    <p id="currentDesc" class="now-desc">--</p>
                    <hr class="card-divider">
                    <p class="now-detail"><i class="far fa-calendar-alt"></i> <span id="currentDate">--</span></p>
                </div>

                <div class="card forecast-5day-card">
                    <h4><i class="far fa-calendar-alt"></i> 5 Days Forecast</h4>
                    <ul id="dailyForecastList" class="daily-forecast-list">
                        <li class="forecast-list-item placeholder"><span>--</span> <img src="https://openweathermap.org/img/wn/01d.png" alt="-"> <span>--°/--°C</span></li>
                        <li class="forecast-list-item placeholder"><span>--</span> <img src="https://openweathermap.org/img/wn/01d.png" alt="-"> <span>--°/--°C</span></li>
                        <li class="forecast-list-item placeholder"><span>--</span> <img src="https://openweathermap.org/img/wn/01d.png" alt="-"> <span>--°/--°C</span></li>
                        <li class="forecast-list-item placeholder"><span>--</span> <img src="https://openweathermap.org/img/wn/01d.png" alt="-"> <span>--°/--°C</span></li>
                        <li class="forecast-list-item placeholder"><span>--</span> <img src="https://openweathermap.org/img/wn/01d.png" alt="-"> <span>--°/--°C</span></li>
                    </ul>
                </div>
            </div>

            <div class="right-column">
                <h4>Today's Highlights</h4>
                <div class="highlights-grid">
                    <div class="card highlight-card aqi-card">
                        <h5>Air Quality Index</h5>
                        <div class="aqi-main">
                            <i class="fas fa-wind aqi-icon"></i>
                            <div class="aqi-info">
                                <span id="aqiValue" class="aqi-value">--</span>
                                <span id="aqiDesc" class="aqi-desc">--</span>
                            </div>
                        </div>
                        <div id="airComponents" class="air-components">
                            <span>PM2.5: --</span> <span>SO2: --</span> <span>NO2: --</span> <span>O3: --</span>
                        </div>
                    </div>
                    <div class="card highlight-card sunrise-sunset-card">
                        <h5>Sunrise & Sunset</h5>
                        <div class="sun-item">
                            <i class="fas fa-sun sun-icon"></i>
                            <div class="sun-info">
                                <span>Sunrise</span>
                                <span id="currentSunrise" class="sun-time">--:--</span>
                            </div>
                        </div>
                        <div class="sun-item">
                            <i class="fas fa-moon sun-icon"></i>
                            <div class="sun-info">
                                <span>Sunset</span>
                                <span id="currentSunset" class="sun-time">--:--</span>
                            </div>
                        </div>
                    </div>
                    <div class="card highlight-card">
                        <h5>Humidity</h5>
                        <div class="highlight-content">
                            <i class="fas fa-tint highlight-icon"></i>
                            <span id="detailHumidity" class="highlight-value">-- %</span>
                        </div>
                    </div>
                    <div class="card highlight-card">
                        <h5>Pressure</h5>
                        <div class="highlight-content">
                            <i class="fas fa-tachometer-alt highlight-icon"></i>
                            <span id="detailPressure" class="highlight-value">-- hPa</span>
                        </div>
                    </div>
                    <div class="card highlight-card">
                        <h5>Visibility</h5>
                        <div class="highlight-content">
                            <i class="fas fa-eye highlight-icon"></i>
                            <span id="detailVisibility" class="highlight-value">-- km</span>
                        </div>
                    </div>
                    <div class="card highlight-card">
                        <h5>Wind Speed</h5>
                        <div class="highlight-content">
                            <i class="fas fa-wind highlight-icon"></i>
                            <span id="detailWind" class="highlight-value">-- km/h</span>
                        </div>
                    </div>
                    <div class="card highlight-card">
                        <h5>Feels Like</h5>
                        <div class="highlight-content">
                            <i class="fas fa-temperature-high highlight-icon"></i>
                            <span id="currentFeelsLike" class="highlight-value">--°C</span>
                        </div>
                    </div>
                    <div class="card highlight-card">
                        <h5>UV Index</h5>
                        <div class="highlight-content">
                            <i class="fas fa-sun highlight-icon"></i>
                            <span id="uvIndex" class="highlight-value">--</span>
                        </div>
                    </div>
                </div>

                <div class="card chart-card">
                    <h4><i class="fas fa-chart-line"></i> Hourly Temperature (24h)</h4>
                    <canvas id="hourlyTempChart"></canvas>
                </div>

                <div class="card map-card">
                    <h4><i class="fas fa-map-marked-alt"></i> Weather Map</h4>
                    <div class="map-controls">
                        <label for="mapLayerSelect">Layer:</label>
                        <select id="mapLayerSelect">
                            <option value="temp_new">Temperature</option>
                            <option value="precipitation_new">Precipitation</option>
                            <option value="clouds_new">Clouds</option>
                            <option value="wind_new">Wind Speed</option>
                            <option value="pressure_new">Pressure</option>
                        </select>
                    </div>
                    <div id="map"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
const cityInput = document.getElementById('cityInput');
const searchBtn = document.getElementById('searchBtn');
const currentLocBtn = document.getElementById('currentLocBtn');
const loader = document.getElementById('loader');
const errorMessage = document.getElementById('errorMessage');
const weatherResults = document.getElementById('weather-results');

let chartInstance = null;

// ==========================
// Fetch Weather From Flask
// ==========================

async function fetchWeather(city) {
    loader.style.display = "block";
    errorMessage.style.display = "none";
    weatherResults.style.display = "none";

    try {
        const response = await fetch(`/api/weather_bundle?city=${city}`);
        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.error || "Something went wrong");
        }

        updateUI(data);

    } catch (error) {
        errorMessage.innerText = error.message;
        errorMessage.style.display = "block";
    } finally {
        loader.style.display = "none";
    }
}

// ==========================
// Update UI
// ==========================

function updateUI(data) {
    weatherResults.style.display = "block";

    document.getElementById("locationName").innerText =
        `${data.location.name}, ${data.location.country}`;

    document.getElementById("currentTemp").innerText =
        Math.round(data.current.main.temp) + "°C";

    document.getElementById("currentFeelsLike").innerText =
        Math.round(data.current.main.feels_like) + "°C";

    document.getElementById("currentDesc").innerText =
        data.current.weather[0].description;

    document.getElementById("currentIcon").src =
        `https://openweathermap.org/img/wn/${data.current.weather[0].icon}@2x.png`;

    document.getElementById("detailHumidity").innerText =
        data.current.main.humidity + " %";

    document.getElementById("detailPressure").innerText =
        data.current.main.pressure + " hPa";

    document.getElementById("detailVisibility").innerText =
        (data.current.visibility / 1000).toFixed(1) + " km";

    document.getElementById("detailWind").innerText =
        data.current.wind.speed + " m/s";

    // AQI
    const aqi = data.air_pollution.list[0].main.aqi;
    document.getElementById("aqiValue").innerText = aqi;
    document.getElementById("aqiDesc").innerText = getAQIDescription(aqi);

    // Forecast List
    updateForecast(data.forecast.list);

    // Chart
    updateChart(data.forecast.list);
}

// ==========================
// AQI Description
// ==========================

function getAQIDescription(aqi) {
    const levels = {
        1: "Good",
        2: "Fair",
        3: "Moderate",
        4: "Poor",
        5: "Very Poor"
    };
    return levels[aqi] || "--";
}

// ==========================
// Forecast List
// ==========================

function updateForecast(list) {
    const forecastList = document.getElementById("dailyForecastList");
    forecastList.innerHTML = "";

    const daily = list.filter(item => item.dt_txt.includes("12:00:00"));

    daily.forEach(day => {
        const li = document.createElement("li");
        li.classList.add("forecast-list-item");

        li.innerHTML = `
            <span>${new Date(day.dt_txt).toDateString()}</span>
            <img src="https://openweathermap.org/img/wn/${day.weather[0].icon}.png">
            <span>${Math.round(day.main.temp_min)}° / ${Math.round(day.main.temp_max)}°</span>
        `;

        forecastList.appendChild(li);
    });
}

// ==========================
// Chart
// ==========================

function updateChart(list) {
    const ctx = document.getElementById("hourlyTempChart").getContext("2d");

    const labels = list.slice(0, 8).map(item =>
        new Date(item.dt_txt).getHours() + ":00"
    );

    const temps = list.slice(0, 8).map(item =>
        item.main.temp
    );

    if (chartInstance) {
        chartInstance.destroy();
    }

    chartInstance = new Chart(ctx, {
        type: "line",
        data: {
            labels: labels,
            datasets: [{
                label: "Temperature (°C)",
                data: temps,
                borderColor: "#667eea",
                backgroundColor: "rgba(102,126,234,0.2)",
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false }
            }
        }
    });
}

// ==========================
// Event Listeners
// ==========================

searchBtn.addEventListener("click", () => {
    if (cityInput.value.trim() !== "") {
        fetchWeather(cityInput.value.trim());
    }
});

cityInput.addEventListener("keypress", (e) => {
    if (e.key === "Enter") {
        searchBtn.click();
    }
});

currentLocBtn.addEventListener("click", () => {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(async position => {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;

            try {
                const response = await fetch(`/api/weather_bundle?city=${lat},${lon}`);
                const data = await response.json();
                updateUI(data);
            } catch (err) {
                alert("Unable to fetch location weather.");
            }
        });
    }
});
</script>
